<html>
<head>

<style type="text/css">

.incorrect .indicator {
	background: red;
}

.correct .indicator {
	background: lightgreen;
}

.pending .indicator {
	background: yellow;
}

</style>

<script src="https://code.jquery.com/jquery-1.11.3.js" type="text/javascript"></script>

<script id="test-template" type="text/x-custom-template">
	<table>
		<tr>
			<td rowspan="2" class="indicator" style="width: 20"></td>
			<td>Input: <input type="text" value="" class="input" /></td>
		</tr>
		<tr>
			<td>Output: <input type="text" value="" class="output" /></td>
		</tr>
	</table>
</script>

<script type="text/javascript">

var tests = [ "1 5" , "5 6" , "5 6" ];
var outputs = [ "6" , "11" , "12" ];

var add_test = function(input, output) {
	var template = $('#test-template').html();
	var control = $(template);
	control.find(".input").val(input);
	control.find(".output").val(output);
	$('#divTests').append(control);
};

var get_test_controls = function() {
	return $("#divTests table");
};

var set_status = function(statuses) {
	var testControls = get_test_controls();
	$.each(testControls, function (i, ctrl) {
		$(ctrl).removeClass('correct incorrect pending');
		$(ctrl).addClass(statuses[i]);
	});
};

var init_test_controls = function() {
	$.each(tests, function (i, t) {
		add_test(t, outputs[i]);
	});
};

var collect_tests = function() {
	var testControls = get_test_controls();
	var inputs = $.map(testControls, function (control) { return $(control).find(".input").val(); });
	var outputs = $.map(testControls, function (control) { return $(control).find(".output").val(); });
	return {
		input: JSON.stringify(inputs),
		output: JSON.stringify(outputs),
	};
};

var on_executed = function(result) {
	var executionResults = JSON.parse(result);
	var statuses = $.map(executionResults, function(r) { return r.successful ? "correct" : "incorrect"; });
	set_status(statuses);
};

var run = function() {
	var testControls = get_test_controls();
	var pendingStatuses = $.map(testControls, function() { return 'pending'; });
	set_status(pendingStatuses);

    var editor = ace.edit("editor");
	var code = editor.getValue();
	var data = { };
	
	collect_tests();
	
	$.extend(data, 
		collect_tests(),
		{
			csrfmiddlewaretoken: '{{ csrf_token }}',
			code: code,
		}
	);
	
	var response = $.post('run', data = data, success = on_executed);
};

$(function() {
	init_test_controls();

	$("#btnRun").click(run);
	$("#btnAddTest").click(function () { add_test("", ""); });
});

</script>

</head>
<body>

<div style="float:left">
<div id="editor" style="width:500px; height: 500px">#include &lt;iostream&gt;

using namespace std;

int main() {
	int a, b;
	cin >> a >> b;
	cout << a + b;
}</div>
<script src="https://cdn.jsdelivr.net/ace/1.2.1/min/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/c_cpp");
</script>
</div>

<div style="float:right">
	<input type="button" id="btnAddTest" value="Add test" />
	<div id="divTests">
	</div>
</div>

<div>
<input type="button" value="Run" id="btnRun" />
</div>

</body>
</html>